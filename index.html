<!doctype html>
<html lang="fa-AF" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Code Bank</title>
  <link rel="manifest" href="manifest.json">
  <!-- icons -->
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>

  <!-- font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;700;900&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/dangnelson/car-makes-icons/dist/style.css">

<style>
/* Root colors - Modern blue theme */
:root{
  --bg: #0f1720;
  --bg-secondary: #1a2430;
  --bg-tertiary: #243142;
  --muted: #8b9bab;
  --muted-dark: #5b6b6f;
  --primary-1: #3b82f6;
  --primary-2: #2563eb;
  --primary-3: #1d4ed8;
  --accent-1: #06b6d4;
  --accent-2: #0891b2;
  --card-white: #ffffff;
  --text-dark: #071218;
  --text-light: #e6eef6;
  --wa-green: #25D366;
  --gap: 12px;
  --border-radius: 12px;
  --shadow: 0 8px 30px rgba(0,0,0,0.12);
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;scroll-behavior:smooth}
body{
  font-family:"Noto Sans Arabic", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background:linear-gradient(180deg,#0b1220 0%,#0f1720 100%);
  color:var(--text-light);
  min-height:100vh;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  line-height:1.6;
}
a{color:var(--text-light);text-decoration:none;transition:var(--transition)}
a:hover{color:var(--accent-1)}

/* Top bar */
.topsec{
  display:flex;align-items:center;justify-content:space-between;
  padding:12px 16px;background:linear-gradient(90deg,rgba(59,130,246,0.1),rgba(59,130,246,0.05));
  border-bottom:1px solid rgba(59,130,246,0.1);position:sticky;top:0;z-index:40;
  backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
}
.brand{display:flex;align-items:center;gap:10px;min-width:0;flex:1}
.brand h1{font-size:1.1rem;margin:0;font-weight:900;white-space:nowrap;color:var(--primary-1);text-shadow:0 2px 4px rgba(0,0,0,0.3)}
.top-actions{display:flex;gap:8px;align-items:center}
.icon-btn{background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);padding:10px;border-radius:var(--border-radius);cursor:pointer;display:inline-flex;align-items:center;justify-content:center;transition:var(--transition);color:var(--primary-1)}
.icon-btn:hover{background:rgba(59,130,246,0.2);transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.icon-btn ion-icon{font-size:20px;color:var(--primary-1)}

/* Navigation - user info */
.navigation{
  display:flex;gap:8px;align-items:start;padding:12px 16px;
  background:rgba(59,130,246,0.03);border-bottom:1px solid rgba(59,130,246,0.08);
  overflow-x:auto;white-space:nowrap;scrollbar-width:none;justify-content:flex-start;
}
.navigation::-webkit-scrollbar{display:none}
.user-info{display:inline-flex;align-items:end;gap:12px;background:linear-gradient(90deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:12px;min-width:220px}
.user-avatar{width:44px;height:44px;border-radius:50%;overflow:hidden;display:inline-block;background:rgba(255,255,255,0.06);flex-shrink:0}
.user-avatar img{width:100%;height:100%;object-fit:cover;display:block}
.user-meta{text-align:right;line-height:1;min-width:0}
.user-meta .name{font-weight:800;color:var(--text-light);font-size:0.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.user-meta .id{font-size:0.85rem;color:var(--muted)}
.btn-logout{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text-light);padding:6px 8px;border-radius:8px;cursor:pointer;font-weight:700;font-size:0.85rem}
.btn-logout:hover{transform:translateY(-2px)}

/* container */
.content{padding:20px 16px;padding-bottom:120px;max-width:1300px;margin:0 auto;color:var(--text-dark)}

/* AD banner (now text-only, no image, no button) */
.ad-banner{
  width:100%;max-width:980px;margin:16px auto;padding:18px;border-radius:var(--border-radius);
  display:flex;flex-direction:column;gap:10px;align-items:stretch;justify-content:flex-start;
  background:linear-gradient(135deg,rgba(59,130,246,0.06),rgba(59,130,246,0.03));
  border:1px solid rgba(59,130,246,0.12);color:#fff;box-shadow:var(--shadow);
}
.ad-banner .ad-title{font-size:1.25rem;font-weight:900;color:var(--primary-1);white-space:normal;overflow:hidden;text-overflow:ellipsis}
.ad-banner .ad-desc{color:var(--muted);font-size:1rem;white-space:normal;overflow:hidden}
.ad-banner .ad-meta{display:flex;gap:12px;align-items:center;justify-content:flex-start;flex-wrap:wrap;color:var(--muted);font-size:0.9rem}

/* Browsing section */
.browse-section{margin-top:24px;direction:rtl;color:#fff}
.browse-section h2{margin:8px 0 16px 0;color:var(--text-dark);font-weight:800;font-size:1.4rem;text-align:right}
.makes-row,.models-row{display:flex;gap:12px;overflow-x:auto;overflow-y:hidden;white-space:nowrap;padding:8px 4px 16px 4px;scroll-behavior:smooth;-webkit-overflow-scrolling:touch;scrollbar-width:thin;scrollbar-color:var(--primary-2) transparent}
.makes-row::-webkit-scrollbar,.models-row::-webkit-scrollbar{height:6px}
.make-btn{flex:0 0 auto;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);padding:12px 16px;border-radius:var(--border-radius);cursor:pointer;color:#fff;font-weight:700;display:flex;align-items:center;gap:12px;transition:var(--transition);min-width:160px}
.make-btn img{width:50px;height:50px;object-fit:contain;border-radius:8px}
.make-btn.active{background:linear-gradient(135deg,var(--primary-1),var(--primary-2));color:white;border-color:rgba(37,99,235,0.3);box-shadow:0 4px 15px rgba(59,130,246,0.3);transform:translateY(-2px)}
.model-card{flex:0 0 auto;min-width:180px;background:rgba(255,255,255,0.95);color:var(--text-dark);padding:16px;border-radius:var(--border-radius);display:flex;flex-direction:column;gap:12px;scroll-snap-align:start;border:1px solid rgba(59,130,246,0.2);transition:var(--transition);box-shadow:var(--shadow);position:relative}
.variant-card{background:rgba(255,255,255,0.95);color:var(--text-dark);padding:20px;border-radius:var(--border-radius);border:1px solid rgba(59,130,246,0.2);display:flex;flex-direction:column;gap:12px;position:relative;overflow:hidden;transition:var(--transition);box-shadow:var(--shadow)}
.variant-card .variant-year{background:linear-gradient(135deg,var(--primary-1),var(--primary-2));color:white;padding:6px 12px;border-radius:8px;font-size:1rem;font-weight:800;display:inline-block;margin-bottom:8px;box-shadow:0 2px 8px rgba(59,130,246,0.3)}
.variant-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:8px}
.taxResult{background:rgba(255,255,255,0.95);border-radius:var(--border-radius);padding:16px;margin-top:12px;border:1px solid rgba(59,130,246,0.2);box-shadow:0 4px 15px rgba(0,0,0,0.1)}
.loader{border:3px solid rgba(59,130,246,0.1);border-top:3px solid var(--primary-2);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:20px auto}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
@media (max-width:768px){.ad-banner{padding:14px}}
:root{
  --bg: #0f1720;
  --bg-secondary: #1a2430;
  --bg-tertiary: #243142;
  --muted: #8b9bab;
  --muted-dark: #5b6b6f;
  --primary-1: #3b82f6;
  --primary-2: #2563eb;
  --primary-3: #1d4ed8;
  --accent-1: #06b6d4;
  --accent-2: #0891b2;
  --card-white: #ffffff;
  --text-dark: #071218;
  --text-light: #e6eef6;
  --wa-green: #25D366;
  --gap: 12px;
  --border-radius: 12px;
  --shadow: 0 8px 30px rgba(0,0,0,0.12);
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

*{
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body{
  height: 100%;
  scroll-behavior: smooth;
}

body{
  font-family: "Noto Sans Arabic", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background: linear-gradient(180deg, #0b1220 0%, #0f1720 100%);
  color: var(--text-light);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  line-height: 1.6;
}

a{
  color: var(--text-light);
  text-decoration: none;
  transition: var(--transition);
}

a:hover{
  color: var(--accent-1);
}

/* Top bar - Enhanced */
.topsec{
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 16px;
  background: linear-gradient(90deg, rgba(59,130,246,0.1), rgba(59,130,246,0.05));
  border-bottom: 1px solid rgba(59,130,246,0.1);
  position: sticky;
  top: 0;
  z-index: 40;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.brand{
  display: flex;
  align-items: center;
  gap: 10px;
  min-width: 0;
  flex: 1;
}

.brand h1{
  font-size: 1.1rem;
  margin: 0;
  font-weight: 900;
  white-space: nowrap;
  color: var(--primary-1);
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

#mir{
  font-size: 0.95rem;
  color: var(--muted);
  max-width: 40vw;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.top-actions{
  display: flex;
  gap: 8px;
  align-items: center;
}

.icon-btn{
  background: rgba(59,130,246,0.1);
  border: 1px solid rgba(59,130,246,0.2);
  padding: 10px;
  border-radius: var(--border-radius);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
  color: var(--primary-1);
}

.icon-btn:hover{
  background: rgba(59,130,246,0.2);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.icon-btn ion-icon{
  font-size: 20px;
  color: var(--primary-1);
}

/* Navigation - Fixed اشتراک گذاری button */
.navigation{
  display: flex;
  gap: 8px;
  align-items: center;
  padding: 12px 16px;
  background: rgba(59,130,246,0.05);
  border-bottom: 1px solid rgba(59,130,246,0.1);
  overflow-x: auto;
  white-space: nowrap;
  scrollbar-width: none;
}

.navigation::-webkit-scrollbar{
  display: none;
}

.navigation a{
  color: var(--text-light);
  text-decoration: none;
  padding: 10px 16px;
  border-radius: var(--border-radius);
  display: inline-block;
  font-weight: 600;
  background: rgba(59,130,246,0.08);
  border: 1px solid rgba(59,130,246,0.15);
  transition: var(--transition);
  flex-shrink: 0;
}

.navigation a:hover{
  background: rgba(59,130,246,0.15);
  transform: translateY(-2px);
}

/* Fixed اشتراک گذاری button */
#shareBtn{
  background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: var(--border-radius);
  cursor: pointer;
  font-weight: 800;
  font-family: inherit;
  font-size: 0.95rem;
  transition: var(--transition);
  flex-shrink: 0;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

#shareBtn:hover{
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
  background: linear-gradient(135deg, var(--primary-2), var(--primary-3));
}

#shareBtn:active{
  transform: translateY(0);
}

/* container */
.content{
  padding: 20px 16px;
  padding-bottom: 120px;
  max-width: 1300px;
  margin: 0 auto;
  color: var(--text-dark);
}

/* Banner area - Enhanced */
.ad-banner {
  width: 100%;
  max-width: 980px;
  margin: 16px auto;
  padding: 20px;
  border-radius: var(--border-radius);
  display: flex;
  flex-direction: column;
  gap: 16px;
  align-items: stretch;
  justify-content: flex-start;
  background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(59,130,246,0.05));
  border: 1px solid rgba(59,130,246,0.15);
  color: #fff;
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
  transition: var(--transition);
}

.ad-banner:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.2);
}

.ad-banner .ad-top {
  display: flex;
  gap: 16px;
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.ad-banner .ad-left { 
  display: flex; 
  gap: 16px; 
  align-items: center; 
  min-width: 0; 
  flex: 1;
}

.ad-banner .ad-info { 
  min-width: 0; 
  overflow: hidden; 
  text-align: right; 
}

.ad-banner .ad-title { 
  font-size: 1.3rem; 
  font-weight: 900; 
  color: var(--primary-1); 
  white-space: nowrap; 
  overflow: hidden; 
  text-overflow: ellipsis;
  margin-bottom: 4px;
}

.ad-banner .ad-desc { 
  color: var(--muted); 
  font-size: 1rem; 
  overflow: hidden; 
  text-overflow: ellipsis; 
  white-space: nowrap; 
}

.ad-banner .ad-actions { 
  display: flex; 
  gap: 12px; 
  align-items: center; 
  margin-inline-start: auto; 
  flex-shrink: 0;
}

.ad-banner .ad-btn{ 
  padding: 12px 20px; 
  border-radius: var(--border-radius); 
  background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
  color: white; 
  font-weight: 800; 
  border: none; 
  cursor: pointer; 
  transition: var(--transition);
  font-size: 0.95rem;
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.ad-banner .ad-btn:hover{
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.ad-banner .ad-img-large {
  width: 100%;
  max-width: 980px;
  height: auto;
  margin: 0 auto;
  border-radius: 10px;
  display: block;
  object-fit: cover;
  box-shadow: 0 8px 32px rgba(0,0,0,0.15);
  cursor: pointer;
  transition: var(--transition);
}

.ad-banner .ad-img-large:hover{
  transform: scale(1.02);
  box-shadow: 0 12px 40px rgba(0,0,0,0.25);
}

/* Browsing section layout - Enhanced */
.browse-section {
  margin-top: 24px;
  direction: rtl;
  color: #fff;
}

.browse-section h2{
  margin: 8px 0 16px 0;
  color: var(--text-dark);
  font-weight: 800;
  font-size: 1.4rem;
  text-align: right;
}

/* Makes & models rows: horizontal scroll - Enhanced */
.makes-row,
.models-row {
  display: flex;
  gap: 12px;
  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;
  padding: 8px 4px 16px 4px;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: var(--primary-2) transparent;
}

.makes-row::-webkit-scrollbar,
.models-row::-webkit-scrollbar{
  height: 6px;
}

.makes-row::-webkit-scrollbar-track,
.models-row::-webkit-scrollbar-track{
  background: rgba(59,130,246,0.1);
  border-radius: 10px;
}

.makes-row::-webkit-scrollbar-thumb,
.models-row::-webkit-scrollbar-thumb{
  background: var(--primary-2);
  border-radius: 10px;
}

.make-btn {
  flex: 0 0 auto;
  background: rgba(59,130,246,0.1);
  border: 1px solid rgba(59,130,246,0.2);
  padding: 12px 16px;
  border-radius: var(--border-radius);
  cursor: pointer;
  color: #fff;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: var(--transition);
  min-width: 160px;
}

.make-btn:hover{
  background: rgba(59,130,246,0.2);
  transform: translateY(-2px);
  border-color: rgba(59,130,246,0.4);
}

.make-btn img { 
  width: 50px; 
  height: 50px; 
  object-fit: contain; 
  border-radius: 8px; 
}

.make-btn.active {
  background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
  color: white;
  border-color: rgba(37, 99, 235, 0.3);
  box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
  transform: translateY(-2px);
}

/* Models behave similarly to makes */
.model-card {
  flex: 0 0 auto;
  min-width: 180px;
  background: rgba(255, 255, 255, 0.95);
  color: var(--text-dark);
  padding: 16px;
  border-radius: var(--border-radius);
  display: flex;
  flex-direction: column;
  gap: 12px;
  scroll-snap-align: start;
  border: 1px solid rgba(59,130,246,0.2);
  transition: var(--transition);
  box-shadow: var(--shadow);
  position: relative;
}

.model-card:hover{
  transform: translateY(-3px);
  box-shadow: 0 12px 30px rgba(0,0,0,0.15);
}

/* Make year more visible in model cards */
.model-card .model-year {
  position: absolute;
  top: 8px;
  left: 8px;
  background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
  color: white;
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 0.8rem;
  font-weight: 700;
  z-index: 2;
}

.model-card .model-title {
  font-weight: 800;
  font-size: 1.1rem;
  margin-top: 8px;
  color: var(--text-dark);
}

/* Keep variants as a grid */
.variants-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

/* Variant card - Enhanced */
.variant-card {
  background: rgba(255,255,255,0.95);
  color: var(--text-dark);
  padding: 20px;
  border-radius: var(--border-radius);
  border: 1px solid rgba(59,130,246,0.2);
  display: flex;
  flex-direction: column;
  gap: 12px;
  position: relative;
  overflow: hidden;
  transition: var(--transition);
  box-shadow: var(--shadow);
}

.variant-card:hover{
  transform: translateY(-3px);
  box-shadow: 0 12px 35px rgba(0,0,0,0.15);
}

/* Fixed watermark for variant card - more visible */
.variant-card::after {
  content: attr(data-watermark);
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) rotate(-22deg);
  font-size: 2rem;
  color: rgba(0,0,0,0.15);
  font-weight: 900;
  pointer-events: none;
  white-space: nowrap;
  letter-spacing: 3px;
  text-transform: uppercase;
  z-index: 1;
  opacity: 0.8;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

/* Make year more prominent in variant cards */
.variant-card .variant-year {
  background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
  color: white;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 800;
  display: inline-block;
  margin-bottom: 8px;
  box-shadow: 0 2px 8px rgba(59,130,246,0.3);
}

/* meta and actions */
.variant-card .meta { 
  font-size: 0.9rem; 
  color: var(--muted-dark); 
}

.variant-actions { 
  display: flex; 
  gap: 12px; 
  justify-content: flex-end;
  margin-top: 8px;
}

.tax-btn, .calculate-btn { 
  background: linear-gradient(135deg, var(--primary-1), var(--primary-2));
  border: none; 
  padding: 12px 20px; 
  border-radius: var(--border-radius); 
  cursor: pointer; 
  color: white; 
  font-weight: 800; 
  transition: var(--transition);
  font-size: 0.95rem;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  flex: 1;
}

.tax-btn:hover, .calculate-btn:hover{
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(59, 130, 246, 0.4);
}

/* small helpers */
.meta-row{
  font-size: 0.9rem;
  color: var(--muted-dark);
  padding: 4px 0;
}

/* Make breadcrumb more visible */
.variant-card > div:first-child {
  font-size: 0.95rem;
  color: var(--primary-2);
  font-weight: 700;
  margin-bottom: 8px;
  padding: 8px 0;
  border-bottom: 1px solid rgba(59,130,246,0.1);
}

/* Result box styling */
.taxResult {
  background: rgba(255,255,255,0.95);
  border-radius: var(--border-radius);
  padding: 16px;
  margin-top: 12px;
  border: 1px solid rgba(59,130,246,0.2);
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.taxResult p {
  margin: 8px 0;
  font-size: 0.95rem;
  color: var(--text-dark);
}

/* USD Rate display */
.usd-rate {
  font-weight: 800;
  color: var(--primary-1);
  margin-left: 12px;
  white-space: nowrap;
  min-width: 160px;
  text-align: right;
  background: rgba(59,130,246,0.1);
  padding: 8px 12px;
  border-radius: var(--border-radius);
  border: 1px solid rgba(59,130,246,0.2);
}

/* Section labels */
.browse-section > div > div:first-child {
  font-weight: 800;
  margin-bottom: 8px;
  color: var(--text-light);
  font-size: 1.1rem;
  padding-right: 4px;
}

/* Responsive tweaks */
@media (max-width: 900px){
  .company-logo{width:14vmin;height:14vmin;}
  .variants-grid{
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  }
}

@media (max-width: 768px){
  .ad-banner .ad-top{
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }
  
  .ad-banner .ad-left{
    justify-content: center;
    text-align: center;
  }
  
  .ad-banner .ad-info{
    text-align: center;
  }
  
  .ad-banner .ad-actions{
    justify-content: center;
  }
  
  .variants-grid{
    grid-template-columns: 1fr;
    gap: 12px;
  }
}

@media (max-width: 600px){
  .topsec{
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
    padding: 12px;
  }
  
  .brand h1{display: none;}
  
  .navigation{
    padding: 10px 12px;
    gap: 6px;
  }
  
  .navigation a,
  #shareBtn{
    padding: 10px 14px;
    font-size: 0.9rem;
  }
  
  .ad-banner{
    padding: 16px;
    margin: 12px auto;
  }
  
  .ad-banner .ad-title{
    font-size: 1.1rem;
  }
  
  .ad-banner .ad-desc{
    font-size: 0.9rem;
  }
  
  .make-btn{
    min-width: 140px;
    padding: 10px 14px;
  }
  
  .model-card{
    min-width: 160px;
    padding: 14px;
  }
  
  .variant-card{
    padding: 16px;
  }
  
  .usd-rate{
    min-width: auto;
    text-align: center;
    margin: 0;
  }
  
  /* Make watermark smaller on mobile */
  .variant-card::after {
    font-size: 1.5rem;
    letter-spacing: 2px;
  }
}

@media (max-width: 480px){
  .content{
    padding: 16px 12px;
  }
  
  .makes-row,
  .models-row{
    gap: 8px;
  }
  
  .make-btn{
    min-width: 130px;
    padding: 10px 12px;
    gap: 8px;
  }
  
  .make-btn img{
    width: 40px;
    height: 40px;
  }
  
  .model-card{
    min-width: 150px;
    padding: 12px;
  }
  
  .variant-actions{
    flex-direction: column;
  }
  
  .tax-btn, .calculate-btn{
    width: 100%;
  }
}

/* Loading states */
.loader{
  border: 3px solid rgba(59,130,246,0.1);
  border-top: 3px solid var(--primary-2);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 20px auto;
}

@keyframes spin{
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Focus states for accessibility */
button:focus,
a:focus{
  outline: 2px solid var(--primary-2);
  outline-offset: 2px;
}

/* Smooth scrolling for older browsers */
@media (prefers-reduced-motion: reduce){
  *{
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
</style>

</head>
<body>

  <header class="topsec">
    <div class="brand" style="align-items:center">
      <h1>Code Bank</h1>

      <div id="usdRate" class="usd-rate" aria-live="polite" style="font-weight:800;color:var(--gold-1);margin-left:12px;white-space:nowrap;min-width:160px;text-align:right">
        نرخ دالر: —
      </div>

      <div class="top-actions">
        <a href="https://wa.me/93703432654" target="_blank" class="icon-btn" aria-label="WhatsApp"><ion-icon name="logo-whatsapp"></ion-icon></a>
      </div>
    </div>
  </header>

  <!-- User info navigation (replaces previous three-button nav) -->
  <nav class="navigation" role="navigation" aria-label="اطلاعات کاربر">
    <div id="userInfo" class="user-info" aria-live="polite" title="اطلاعات حساب کاربری">
      <div class="user-avatar" id="userAvatar"></div>
      <div class="user-meta">
        <div class="name" id="userName">مهمان</div>
        <div class="id" id="userId">ID: —</div>
      </div>
      
    </div>
  </nav>

  <main class="content">
    <!-- AD BANNER placeholder (text-only now) -->
    <div id="adBannerContainer"></div>

    <!-- Browsing UI -->
    <section class="browse-section" aria-label="جستجوی خودروها">
      <h2 style="margin:6px 0 8px 0;color:#fff;">جستجوی بر اساس برند / مدل / سال</h2>

      <div>
        <div style="font-weight:800;margin-bottom:6px;color:#fff">برندها</div>
        <div id="makesRow" class="makes-row" aria-live="polite"></div>
      </div>

      <div style="margin-top:10px">
        <div style="font-weight:800;margin-bottom:6px;color:#fff">مدل‌ها</div>
        <div id="modelsRow" class="models-row"></div>
      </div>

      <div style="margin-top:10px">
        <div style="font-weight:800;margin-bottom:6px;color:#fff">سال‌ها</div>
        <div id="variantsGrid" class="variants-grid" aria-live="polite"></div>
      </div>
    </section>

  </main>

  <div id="result">
    <div class="loader" id="loader"></div>
    <div id="items"><!-- server response will be inserted --></div>
  </div>

<script>
/* Small helpers */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function formatNumber(v){ if (v===null||v===undefined||v==='') return '0'; const n=Number(v); if (isNaN(n)) return v; return n.toLocaleString('en-US',{maximumFractionDigits:2}); }
function numberWithCommas(x){ if (x===null||x===undefined) return '0'; return String(x).replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
</script>

<script>
(function(){
  let DB = null;
  const makesRow = document.getElementById('makesRow');
  const modelsRow = document.getElementById('modelsRow');
  const variantsGrid = document.getElementById('variantsGrid');
  const usdRateEl = document.getElementById('usdRate');

  let currentMakeId = null;
  let currentMakeName = '';
  let currentModelId = null;
  let currentModelName = '';

  // Load JSON data
  fetch('./db.json')
    .then(r => {
      if (!r.ok) throw "JSON NOT FOUND";
      return r.json();
    })
    .then(data => {
      DB = data;
      init();
    })
    .catch(e => {
      alert("db.json not loaded\nPut db.json beside this HTML file\nOpen via http (not file)");
      console.error(e);
    });

  // Get table by name
  function table(name) {
    const tableObj = DB.find(t => t.name === name);
    return tableObj ? tableObj.data : [];
  }

  function init() {
    loadMakes();
    loadUsdRate();
  }

  /* USD rate - static for now */
  function loadUsdRate() {
    // You can modify this to fetch from an API or keep static
    usdRateEl.textContent = 'نرخ دالر: 66.66 افغانی';
  }

  /* Makes */
  function clearActiveMakeButtons(){ 
    const btns = makesRow.querySelectorAll('.make-btn'); 
    btns.forEach(b => b.classList.remove('active')); 
  }

  function createMakeButton(make) {
    const btn = document.createElement('button');
    btn.className = 'make-btn';
    btn.setAttribute('data-id', make.id);
    btn.title = make.name || '';

    if (make.logo) {
      const img = document.createElement('img');
      img.src = make.logo;
      img.alt = make.name + ' logo';
      img.width = 50; img.height = 50; img.loading = 'lazy';
      btn.appendChild(img);
    } else {
      const ph = document.createElement('span');
      ph.style.display = 'inline-block'; 
      ph.style.width = '50px'; 
      ph.style.height = '50px';
      btn.appendChild(ph);
    }

    const nameSpan = document.createElement('span');
    nameSpan.textContent = make.name || '';
    nameSpan.style.fontWeight = '800';
    nameSpan.style.whiteSpace = 'nowrap';
    btn.appendChild(nameSpan);

    btn.addEventListener('click', () => {
      clearActiveMakeButtons(); 
      btn.classList.add('active');
      currentMakeId = make.id; 
      currentMakeName = make.name || '';
      loadModelsForMake(make.id);
    });
    
    return btn;
  }

  function loadMakes() {
    makesRow.innerHTML = '<div style="color:var(--muted)">در حال بارگذاری...</div>';
    
    if (!DB) return;
    
    const makes = table("makes");
    makesRow.innerHTML = '';
    
    if (!makes || makes.length === 0) {
      makesRow.innerHTML = '<div style="color:var(--muted)">برندی یافت نشد</div>'; 
      return;
    }
    
    makes.forEach(m => makesRow.appendChild(createMakeButton(m)));
    
    // Auto-select first make
    if (makes.length > 0) {
      const firstBtn = makesRow.querySelector('.make-btn');
      if (firstBtn) firstBtn.click();
    }
  }

  function loadModelsForMake(makeId) {
    modelsRow.innerHTML = '<div style="color:var(--muted)">در حال بارگذاری...</div>'; 
    variantsGrid.innerHTML = '';
    
    const models = table("models").filter(x => x.make_id == makeId);
    modelsRow.innerHTML = '';
    
    if (!models || models.length === 0) {
      modelsRow.innerHTML = '<div style="color:var(--muted)">مدلی پیدا نشد</div>'; 
      return;
    }
    
    models.forEach(m => {
      const card = document.createElement('div'); 
      card.className = 'model-card';
      
      const title = document.createElement('div'); 
      title.style.fontWeight = '800'; 
      title.textContent = m.name;
      
      const btn = document.createElement('button'); 
      btn.textContent = 'نمایش سال‌ها'; 
      btn.className = 'tax-btn';
      
      btn.addEventListener('click', () => {
        currentModelId = m.id; 
        currentModelName = m.name || '';
        modelsRow.querySelectorAll('.model-card').forEach(c => c.style.boxShadow = 'none');
        card.style.boxShadow = '0 4px 18px rgba(0,0,0,0.08)';
        loadVariantsForModel(m.id, m.name || '');
      });
      
      card.appendChild(title); 
      card.appendChild(btn); 
      modelsRow.appendChild(card);
    });
  }

  function loadVariantsForModel(modelId, modelName = '') {
    variantsGrid.innerHTML = '<div style="color:var(--muted)">در حال بارگذاری...</div>';
    
    const variants = table("variants").filter(x => x.model_id == modelId);
    variantsGrid.innerHTML = '';
    
    if (!variants || variants.length === 0) { 
      variantsGrid.innerHTML = '<div style="color:var(--muted)">سالی پیدا نشد</div>'; 
      return; 
    }

    variants.forEach(v => {
      const id = v.id;
      const priceVal = v.price ?? 0;
      const taxRateVal = v.tax_rate ?? 0;
      const weightVal = v.weight ?? 0;

      const card = document.createElement('div'); 
      card.className = 'variant-card card';
      
      const watermarkText = `${currentMakeName || ''} ${modelName || currentModelName || ''} ${v.year ?? ''}`.trim();
      card.setAttribute('data-watermark', watermarkText);
      card.setAttribute('data-id', id);
      card.setAttribute('data-price', priceVal);
      card.setAttribute('data-taxrate', taxRateVal);
      card.setAttribute('data-weight', weightVal);

      const hidden = document.createElement('div'); 
      hidden.style.display = 'none'; 
      hidden.className = 'variant-data';
      
      const fields = {
        id: v.id ?? '', make_id: v.make_id ?? '', model_id: v.model_id ?? '', year: v.year ?? '',
        code: v.code ?? '', tsc_code: v.tsc_code ?? '', price: priceVal, tax_rate: taxRateVal, weight: weightVal,
        unit: v.unit ?? '', text1: v.text1 ?? '', text2: v.text2 ?? '', make1: v.make1 ?? '', make2: v.make2 ?? '',
        fuel_type: v.fuel_type ?? '', wheel_type: v.wheel_type ?? '', seats: v.seats ?? '', passengers: v.passengers ?? '',
        wheels: v.wheels ?? '', doors: v.doors ?? '', cylinders: v.cylinders ?? '', steering: v.steering ?? '', country_make: v.country_make ?? ''
      };
      
      Object.keys(fields).forEach(k => hidden.setAttribute('data-' + k, String(fields[k])));

      const breadcrumb = document.createElement('div'); 
      breadcrumb.style.fontSize='0.9rem'; 
      breadcrumb.style.color='var(--muted)';
      breadcrumb.style.marginBottom='6px'; 
      breadcrumb.innerHTML = `${escapeHtml(currentMakeName)} &nbsp;&rsaquo;&nbsp; ${escapeHtml(modelName || currentModelName)} &nbsp;&rsaquo;&nbsp; ${escapeHtml(String(v.year ?? '—'))}`;

      const title = document.createElement('h2'); 
      title.style.margin='0'; 
      title.innerHTML = `${escapeHtml(String(v.year ?? '—'))} ${v.name ? '— ' + escapeHtml(v.name) : ''}`;

      const metaCode = document.createElement('div'); 
      metaCode.className='meta-row'; 
      metaCode.innerHTML = `<span>کد اموال:</span> <strong>${escapeHtml(v.code ?? '')}</strong>`;
      
      const metaTsc = document.createElement('div'); 
      metaTsc.className='meta-row'; 
      metaTsc.innerHTML = `<span>تی سی کد:</span> <strong>${escapeHtml(v.tsc_code ?? '')}</strong>`;

      const priceP = document.createElement('p'); 
      priceP.innerHTML = `قیمت: <strong class="display-price" style="color: green;">${formatNumber(priceVal)}</strong> $`;
      
      const taxP = document.createElement('p'); 
      taxP.innerHTML = `فیصدی مالیات: <strong class="display-taxrate">${formatNumber(taxRateVal)}</strong> %`;
      
      const weightP = document.createElement('p'); 
      weightP.innerHTML = `وزن: <strong class="display-weight">${formatNumber(weightVal)}</strong> kg`;

      const actions = document.createElement('div'); 
      actions.className='variant-actions';
      
      const calcBtn = document.createElement('button'); 
      calcBtn.className='btn calculate-btn'; 
      calcBtn.textContent = 'سنجش'; 
      calcBtn.style.width='auto';
      actions.appendChild(calcBtn);

      const resultBox = document.createElement('div'); 
      resultBox.id = `taxResult-${id}`; 
      resultBox.className='taxResult'; 
      resultBox.style.display='none';
      
      resultBox.innerHTML = `
        <p>رسم العرضیه (0.5%): <span class="raskhorafa"></span> افغانی</p>
        <p>مستوفیت (0.6%): <span class="mostofi"></span> افغانی</p>
        <p class="totalRow" style="display:none">مجموع محصول: <span class="totaltax" style="color:green;font-weight:700;"></span> افغانی</p>
        <p>نرخ دالر: <span class="rate"></span> افغانی</p>
      `;

      card.appendChild(hidden); 
      card.appendChild(breadcrumb); 
      card.appendChild(title);
      card.appendChild(metaCode); 
      card.appendChild(metaTsc); 
      card.appendChild(priceP); 
      card.appendChild(taxP); 
      card.appendChild(weightP);
      card.appendChild(actions); 
      card.appendChild(resultBox);

      calcBtn.addEventListener('click', function(){
        const dataEl = hidden;
        const price = parseFloat(dataEl.getAttribute('data-price')) || 0;
        const taxrate = parseFloat(dataEl.getAttribute('data-tax_rate')) || parseFloat(dataEl.getAttribute('data-taxrate')) || 0;
        const weight = parseFloat(dataEl.getAttribute('data-weight')) || 0;
        
        // Static USD rate (you can change this)
        const usdRate = 66.66;
        
        // Original calculations
        const ZERO42_TAX = 2, ZERO43_TAX = 2, ZERO44_TAX = 0.5, ZERO47_TAX = 4, EIGHTY_EIGHT_TAX = 0.13, ZERO99_TAX = 0.05;
        const PRINT_COST = 400, SERVICE_FEES = 600;
        const zero41 = price * usdRate;
        const zero41Res = (zero41 / 100) * taxrate;
        const zero42 = zero41 + zero41Res;
        const zero42Res = (zero42 / 100) * ZERO42_TAX;
        const zero43 = zero41Res;
        const zero43Res = (zero43 / 100) * ZERO43_TAX;
        const zero44Res = (zero41 / 100) * ZERO44_TAX;
        const zero47Res = (zero42 / 100) * ZERO47_TAX;
        const zero88Res = (weight / 100) * EIGHTY_EIGHT_TAX * 100;
        const zero99Res = (weight / 100) * ZERO99_TAX * 100;
        const tax = zero41Res + zero42Res + zero43Res + zero44Res + zero47Res + zero88Res + zero99Res;
        const fees = PRINT_COST + SERVICE_FEES;
        const total = tax + fees;
        
        // New calculations as requested
        const raskhorafa = (zero41Res * 0.5) / 100;  // 0.5% of zero41Res
        const mostofi = (zero42 * 0.6) / 100;      // 0.006% of zero42
        
        // Update result box with new calculations
        resultBox.querySelector('.raskhorafa').textContent = numberWithCommas(raskhorafa.toFixed(2));
        resultBox.querySelector('.mostofi').textContent = numberWithCommas(mostofi.toFixed(2));
        resultBox.querySelector('.totaltax').textContent = numberWithCommas(total.toFixed(2));
        resultBox.querySelector('.rate').textContent = usdRate.toFixed(2);
        resultBox.querySelector('.totalRow').style.display = 'block';
        resultBox.style.display = 'block';
        resultBox.scrollIntoView({behavior:'smooth', block:'center'});
      });

      variantsGrid.appendChild(card);
    });
  }

  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', function(){
    loadUserInfo();
  });

  window.__carIndex = { loadMakes, loadModelsForMake, loadVariantsForModel, loadUsdRate };
})();
</script>

<script>
/* User info handling - simplified */
function loadUserInfo() {
  const nameEl = document.getElementById('userName');
  const idEl = document.getElementById('userId');
  const avatarEl = document.getElementById('userAvatar');

  // Set default guest user
  nameEl.textContent = 'مهمان';
  idEl.textContent = 'ID: —';
  avatarEl.innerHTML = '<img src="https://via.placeholder.com/44?text=U" alt="avatar">';
}
</script>

</body>
</html>
